{
  "version": 3,
  "sources": ["../../martech/martech.js"],
  "sourcesContent": ["import {\n  getConfig, getMetadata, loadIms, loadLink, loadScript, getMepEnablement,\n} from '../utils/utils.js';\n\nconst ALLOY_SEND_EVENT = 'alloy_sendEvent';\nconst ALLOY_SEND_EVENT_ERROR = 'alloy_sendEvent_error';\nconst TARGET_TIMEOUT_MS = 4000;\nconst ENTITLEMENT_TIMEOUT = 3000;\n\nconst setDeep = (obj, path, value) => {\n  const pathArr = path.split('.');\n  let currentObj = obj;\n\n  for (const key of pathArr.slice(0, -1)) {\n    if (!currentObj[key] || typeof currentObj[key] !== 'object') {\n      currentObj[key] = {};\n    }\n    currentObj = currentObj[key];\n  }\n\n  currentObj[pathArr[pathArr.length - 1]] = value;\n};\n\n// eslint-disable-next-line max-len\nconst waitForEventOrTimeout = (eventName, timeout, returnValIfTimeout) => new Promise((resolve) => {\n  const listener = (event) => {\n    // eslint-disable-next-line no-use-before-define\n    clearTimeout(timer);\n    resolve(event.detail);\n  };\n\n  const errorListener = () => {\n    // eslint-disable-next-line no-use-before-define\n    clearTimeout(timer);\n    resolve({ error: true });\n  };\n\n  const timer = setTimeout(() => {\n    window.removeEventListener(eventName, listener);\n    if (returnValIfTimeout !== undefined) {\n      resolve(returnValIfTimeout);\n    } else {\n      resolve({ timeout: true });\n    }\n  }, timeout);\n\n  window.addEventListener(eventName, listener, { once: true });\n  window.addEventListener(ALLOY_SEND_EVENT_ERROR, errorListener, { once: true });\n});\n\nconst handleAlloyResponse = (response) => {\n  const items = (\n    (response.propositions?.length && response.propositions)\n    || (response.decisions?.length && response.decisions)\n    || []\n  ).map((i) => i.items).flat();\n\n  if (!items?.length) return [];\n\n  return items\n    .map((item) => {\n      const content = item?.data?.content;\n      if (!content || !(content.manifestLocation || content.manifestContent)) return null;\n\n      return {\n        manifestPath: content.manifestLocation || content.manifestPath,\n        manifestUrl: content.manifestLocation,\n        manifestData: content.manifestContent?.experiences?.data || content.manifestContent?.data,\n        manifestPlaceholders: content.manifestContent?.placeholders?.data,\n        manifestInfo: content.manifestContent?.info.data,\n        name: item.meta['activity.name'],\n        variantLabel: item.meta['experience.name'] && `target-${item.meta['experience.name']}`,\n        meta: item.meta,\n      };\n    })\n    .filter(Boolean);\n};\n\nfunction roundToQuarter(num) {\n  return Math.ceil(num / 250) / 4;\n}\n\nfunction calculateResponseTime(responseStart) {\n  const responseTime = Date.now() - responseStart;\n  return roundToQuarter(responseTime);\n}\n\nfunction sendTargetResponseAnalytics(failure, responseStart, timeout, message) {\n  // temporary solution until we can decide on a better timeout value\n  const responseTime = calculateResponseTime(responseStart);\n  const timeoutTime = roundToQuarter(timeout);\n  let val = `target response time ${responseTime}:timed out ${failure}:timeout ${timeoutTime}`;\n  if (message) val += `:${message}`;\n  // eslint-disable-next-line no-underscore-dangle\n  window._satellite?.track?.('event', {\n    documentUnloading: true,\n    xdm: {\n      eventType: 'web.webinteraction.linkClicks',\n      web: {\n        webInteraction: {\n          linkClicks: { value: 1 },\n          type: 'other',\n          name: val,\n        },\n      },\n    },\n    data: { _adobe_corpnew: { digitalData: { primaryEvent: { eventInfo: { eventName: val } } } } },\n  });\n}\n\nexport const getTargetPersonalization = async () => {\n  const params = new URL(window.location.href).searchParams;\n\n  const timeout = parseInt(params.get('target-timeout'), 10)\n    || parseInt(getMetadata('target-timeout'), 10)\n    || TARGET_TIMEOUT_MS;\n\n  const responseStart = Date.now();\n  window.addEventListener(ALLOY_SEND_EVENT, () => {\n    const responseTime = calculateResponseTime(responseStart);\n    try {\n      window.lana.log(`target response time: ${responseTime}`, { tags: 'martech', errorType: 'i' });\n    } catch (e) {\n      // eslint-disable-next-line no-console\n      console.error('Error logging target response time:', e);\n    }\n  }, { once: true });\n\n  let targetManifests = [];\n  let targetPropositions = [];\n  const response = await waitForEventOrTimeout(ALLOY_SEND_EVENT, timeout);\n  if (response.error) {\n    try {\n      window.lana.log('target response time: ad blocker', { tags: 'martech', errorType: 'i' });\n    } catch (e) {\n      // eslint-disable-next-line no-console\n      console.error('Error logging target response time for ad blocker:', e);\n    }\n    return { targetManifests, targetPropositions };\n  }\n  if (response.timeout) {\n    waitForEventOrTimeout(ALLOY_SEND_EVENT, 5100 - timeout)\n      .then(() => sendTargetResponseAnalytics(true, responseStart, timeout));\n  } else {\n    sendTargetResponseAnalytics(false, responseStart, timeout);\n    targetManifests = handleAlloyResponse(response.result);\n    targetPropositions = response.result?.propositions || [];\n  }\n\n  return { targetManifests, targetPropositions };\n};\n\nconst setupEntitlementCallback = () => {\n  const setEntitlements = async (destinations) => {\n    const { getEntitlements } = await import('../features/personalization/personalization.js');\n    return getEntitlements(destinations);\n  };\n\n  const getEntitlements = (resolve) => {\n    const handleEntitlements = (detail) => {\n      if (detail?.result?.destinations?.length) {\n        resolve(setEntitlements(detail.result.destinations));\n      } else {\n        resolve([]);\n      }\n    };\n    waitForEventOrTimeout(ALLOY_SEND_EVENT, ENTITLEMENT_TIMEOUT, [])\n      .then(handleEntitlements)\n      .catch(() => resolve([]));\n  };\n\n  const { miloLibs, codeRoot, entitlements: resolveEnt } = getConfig();\n  getEntitlements(resolveEnt);\n\n  loadLink(\n    `${miloLibs || codeRoot}/features/personalization/personalization.js`,\n    { as: 'script', rel: 'modulepreload' },\n  );\n};\n\nfunction isProxied() {\n  return /^(www|milo|business|blog)(\\.stage)?\\.adobe\\.com$/.test(window.location.hostname);\n}\n\nlet filesLoadedPromise = false;\nconst loadMartechFiles = async (config) => {\n  if (filesLoadedPromise) return filesLoadedPromise;\n\n  filesLoadedPromise = async () => {\n    if (getMepEnablement('xlg') === 'loggedout') {\n      setupEntitlementCallback();\n    } else {\n      loadIms()\n        .then(() => {\n          if (window.adobeIMS.isSignedInUser()) setupEntitlementCallback();\n        })\n        .catch(() => {});\n    }\n\n    setDeep(\n      window,\n      'alloy_all.data._adobe_corpnew.digitalData.page.pageInfo.language',\n      { locale: config.locale.prefix.replace('/', ''), langCode: config.locale.ietf },\n    );\n    setDeep(window, 'digitalData.diagnostic.franklin.implementation', 'milo');\n\n    const launchUrl = config.env.consumer?.marTechUrl || (\n      isProxied()\n        ? '/marketingtech'\n        : 'https://assets.adobedtm.com'\n    ) + (\n      config.env.name === 'prod'\n        ? '/d4d114c60e50/a0e989131fd5/launch-5dd5dd2177e6.min.js'\n        : '/d4d114c60e50/a0e989131fd5/launch-2c94beadc94f-development.min.js'\n    );\n    loadLink(launchUrl, { as: 'script', rel: 'preload' });\n\n    window.marketingtech = {\n      adobe: {\n        launch: {\n          url: launchUrl,\n          controlPageLoad: true,\n        },\n        alloy: {\n          edgeConfigId: config.env.consumer?.edgeConfigId || config.env.edgeConfigId,\n          edgeDomain: (\n            isProxied()\n              ? window.location.hostname\n              : 'sstats.adobe.com'\n          ),\n          edgeBasePath: (\n            isProxied()\n              ? 'experienceedge'\n              : 'ee'\n          ),\n        },\n        target: false,\n      },\n      milo: true,\n    };\n    window.edgeConfigId = config.env.edgeConfigId;\n\n    await loadScript((\n      isProxied()\n        ? ''\n        : 'https://www.adobe.com'\n    ) + (\n      config.env.name === 'prod'\n        ? '/marketingtech/main.standard.min.js'\n        : '/marketingtech/main.standard.qa.min.js'\n    ));\n    // eslint-disable-next-line no-underscore-dangle\n    window._satellite.track('pageload');\n  };\n\n  await filesLoadedPromise();\n  return filesLoadedPromise;\n};\n\nexport default async function init() {\n  const config = getConfig();\n  const martechPromise = loadMartechFiles(config);\n  return martechPromise;\n}\n"],
  "mappings": "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",
  "names": ["getEntitlements"]
}
