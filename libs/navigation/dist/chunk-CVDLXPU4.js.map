{
  "version": 3,
  "sources": ["../../tools/utils/publish.js", "../../utils/sidekick-decorate.js"],
  "sourcesContent": ["import { getCustomConfig } from '../../../tools/utils/utils.js';\n\nconst userCanPublishPage = async (detail, isBulk = true) => {\n  if (!detail) return false;\n  const { live, profile, webPath } = detail;\n  let canPublish = isBulk ? live?.permissions?.includes('write') : true;\n  let message = 'Publishing is currently disabled for this page';\n  const config = await getCustomConfig('/.milo/publish-permissions-config.json');\n  const item = config?.urls?.data?.find(({ url }) => (\n    url.endsWith('**') ? webPath.includes(url.slice(0, -2)) : url === webPath\n  ));\n  if (item) {\n    canPublish = false;\n    if (item.message) message = item.message;\n    const group = config[item.group];\n    if (group && profile?.email) {\n      let isDeny;\n      const user = group.data?.find(({ allow, deny }) => {\n        if (deny) {\n          /* c8 ignore next 3 */\n          isDeny = true;\n          return deny === profile.email;\n        }\n        return allow === profile.email;\n      });\n      canPublish = isDeny ? !user : !!user;\n    }\n  }\n  return { canPublish, message };\n};\n\nexport default userCanPublishPage;\n", "import userCanPublishPage from '../tools/utils/publish.js';\n\nconst PUBLISH_BTN = '.publish.plugin button';\nconst PROFILE = '.profile-email';\nconst CONFIRM_MESSAGE = 'Are you sure? This will publish to production.';\nlet stylePublishCalled = false;\n\nfunction styleHelixPublish(sk) {\n  const setupPublishBtn = async (page, btn) => {\n    const { canPublish, message } = await userCanPublishPage(page, false);\n    if (canPublish) {\n      btn.removeAttribute('disabled');\n    } else {\n      btn.setAttribute('disabled', true);\n    }\n    const messageText = btn.querySelector('span');\n    const text = canPublish ? CONFIRM_MESSAGE : message;\n    if (messageText) {\n      messageText.innerText = text;\n    } else {\n      btn.insertAdjacentHTML('beforeend', `<span>${text}</span>`);\n    }\n  };\n\n  const style = new CSSStyleSheet();\n  style.replaceSync(`\n    :host {\n      --bg-color: rgb(129 27 14);\n      --text-color: #fff0f0;\n      color-scheme: light dark;\n    }\n    .publish.plugin {\n      order: 100;\n    }\n    .publish.plugin button {\n      position: relative;\n    }\n    .publish.plugin button:not([disabled=true]) {\n      background: var(--bg-color);\n      border-color: #b46157;\n      color: var(--text-color);\n    }\n    .publish.plugin button:not([disabled=true]):hover {\n      background-color: var(--hlx-sk-button-hover-bg);\n      border-color: unset;\n      color: var(--hlx-sk-button-hover-color);\n    }\n    .publish.plugin button > span {\n      display: none;\n      background: #666;\n      border-radius: 4px;\n      line-height: 1.2rem;\n      padding: 8px 12px;\n      position: absolute;\n      top: 34px;\n      left: 50%;\n      transform: translateX(-50%);\n      width: 150px;\n      white-space: pre-wrap;\n    }\n    .publish.plugin button:not([disabled=true]) > span {\n      background: var(--bg-color);\n    }\n    .publish.plugin button:hover > span {\n      display: block;\n      color: var(--text-color);\n    }\n    .publish.plugin button > span:before {\n      content: '';\n      border-left: 6px solid transparent;\n      border-right: 6px solid transparent;\n      border-bottom: 6px solid #666;\n      position: absolute;\n      text-align: center;\n      top: -6px;\n      left: 50%;\n      transform: translateX(-50%);\n    }\n    .publish.plugin button:not([disabled=true]) > span:before {\n      border-bottom: 6px solid var(--bg-color);\n    }\n  `);\n\n  sk.shadowRoot.adoptedStyleSheets = [style];\n\n  sk.addEventListener('statusfetched', async (event) => {\n    const page = event?.detail?.data;\n    const btn = event?.target?.shadowRoot?.querySelector(PUBLISH_BTN);\n    if (page && btn) {\n      setupPublishBtn(page, btn);\n    }\n  });\n\n  setTimeout(async () => {\n    const btn = sk.shadowRoot.querySelector(PUBLISH_BTN);\n    btn?.setAttribute('disabled', true);\n    const message = btn?.querySelector('span');\n    if (btn && !message) {\n      const page = {\n        webPath: window.location.pathname,\n        // added for edge case where the statusfetched event isnt fired on refresh\n        profile: { email: sk.shadowRoot.querySelector(PROFILE)?.innerText },\n      };\n      setupPublishBtn(page, btn);\n    }\n  }, 500);\n}\n\nasync function checkAuthorization(page, btn) {\n  const { canPublish, message } = await userCanPublishPage(page, false);\n  if (canPublish) {\n    btn.removeAttribute('disabled');\n    return;\n  }\n\n  btn.setAttribute('disabled', true);\n  btn.insertAdjacentHTML('beforeend', `<span>${message}</span>`);\n  setTimeout(() => btn.querySelector('span').remove(), 4000);\n}\n\nexport default async function stylePublish(sk) {\n  if (stylePublishCalled) return;\n  stylePublishCalled = true;\n\n  if (sk.nodeName === 'HELIX-SIDEKICK') {\n    styleHelixPublish(sk);\n    return;\n  }\n\n  const style = new CSSStyleSheet();\n  style.replaceSync(`\n    sk-action-button.publish {\n      position: relative;\n    }\n    sk-action-button.publish > span {\n      display: none;\n      background: #777;\n      border-radius: 4px;\n      line-height: 1.2rem;\n      padding: 8px 12px;\n      position: absolute;\n      bottom: 34px;\n      left: 50%;\n      transform: translateX(-50%);\n      width: 150px;\n      white-space: pre-wrap;\n      color: black;\n    }\n    sk-action-button.publish[disabled] > span {\n      display: block;\n    }\n    sk-action-button.publish > span:before {\n      content: '';\n      border-left: 6px solid transparent;\n      border-right: 6px solid transparent;\n      border-top: 6px solid #777;\n      position: absolute;\n      text-align: center;\n      bottom: -6px;\n      left: 50%;\n      transform: translateX(-50%);\n    }\n  `);\n\n  const pluginActionBarSR = sk.shadowRoot.querySelector('plugin-action-bar').shadowRoot;\n  pluginActionBarSR.adoptedStyleSheets ??= [];\n  pluginActionBarSR.adoptedStyleSheets.push(style);\n\n  const publishBtn = pluginActionBarSR.querySelector('sk-action-button.publish');\n  if (!publishBtn) {\n    sk.addEventListener('status-fetched', ({ target, detail }) => {\n      setTimeout(async () => {\n        const btn = target.shadowRoot.querySelector('plugin-action-bar').shadowRoot.querySelector('sk-action-button.publish');\n        if (detail && btn) await checkAuthorization(detail, btn);\n      }, 0);\n    });\n  }\n\n  const pageDetail = {\n    webPath: window.location.pathname,\n    profile: { email: pluginActionBarSR.querySelector('#user').shadowRoot.querySelector('.user [slot=\"description\"]')?.innerText },\n  };\n  if (pageDetail && publishBtn) await checkAuthorization(pageDetail, publishBtn);\n}\n"],
  "mappings": "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",
  "names": []
}
