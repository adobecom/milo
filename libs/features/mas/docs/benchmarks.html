
<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <title>M@S Benchmarks</title>
  <script>
    const start = performance.now();
    document.addEventListener('wcms:commerce:ready', () => {
      const end = performance.now();
      window.initTime = end - start;
      console.log(`Commerce loaded in ${window.initTime}ms`);
    });
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Fonts -->
    <link rel="stylesheet" href="https://use.typekit.net/hah7vzn.css">
    <!-- Include any additional stylesheets -->
    <link rel="stylesheet" href="styles.css">
    <script type="module">
      import { init } from './common.js';
      init();
    </script>
</head>

<script>
  const measureCardPerformances = async (container, fragmentId) => {
    return new Promise((resolve, reject) => {
      const result = {};
      const card = document.createElement('merch-card');
      const fragment = document.createElement('aem-fragment');
      fragment.setAttribute('fragment', fragmentId);
      card.appendChild(fragment);
      let timeoutId;
      const onReady = () => {
        clearTimeout(timeoutId);
        result.end = performance.now();
        console.log(`Card ${fragmentId} loaded in ${result.end - result.start}ms`);
        resolve(result);
      };
      card.addEventListener('mas:ready', onReady);    
      timeoutId = setTimeout(() => {
        card.removeEventListener('mas:ready', onReady);
        result.timedOut = true;
        console.log(`Card ${fragmentId} timed out`);
        reject('Timed out');
      }, 5000); // Timeout after 5 seconds
      result.start = performance.now();
      container.appendChild(card);
      result.card = card;    
    });
  };
  const fillContainer = async (container) => {
    const fragmentIds = container.getAttribute('data-benchmark').split(',');
    let limit = container.getAttribute('data-benchmark-limit');
    const adjust = new URL(window.location.href).searchParams.get('adjust') === 'true';
    if (adjust) {
      const referentInitialTime = 94.0;
      const previousLimit = limit;
      if (window.initTime < referentInitialTime) {
        limit = limit * window.initTime / referentInitialTime;
        console.log(`Adjusted limit ${previousLimit} to ${limit}`);
      } else {
        console.log('No need to adjust limit');
      }
    }
    const promises = fragmentIds.map((fragmentId) => measureCardPerformances(container, fragmentId));
    const results = await Promise.allSettled(promises);
    results.forEach((result) => {
      const { card, start, end } = result.status === 'fulfilled' ? result.value : {};
      const length = end - start;
      const lengthDisplay = length.toFixed(2);
      const mask = document.createElement('div');
      mask.style.position = 'absolute';
      mask.style.width = card.offsetWidth + 'px';
      mask.style.height = card.offsetHeight + 'px';
      mask.style.top = card.offsetTop + 'px';
      mask.style.left = card.offsetLeft + 'px';
      mask.textContent = '⏱️ ' + lengthDisplay + 'ms';
      mask.classList.add('benchmark-mask');
      mask.setAttribute('data-benchmark-time', lengthDisplay);
      mask.classList.add(length > limit ? 'benchmark-mask-over-limit' : 'benchmark-mask-under-limit');
      container.appendChild(mask);  
    });        
  }
</script>

<body>
  <main>
    <sp-theme color="light" scale="medium"> 
      <div class="gallery-content">
        <h1 id="ccd-cards" tabindex="-1">CCD cards benchmark<a class="header-cards" href="#ccd-cards" href="#ccd-cards" title="Permalink to this heading">#</a></h1>
        <div class="gallery-grid-3 ccd-cards"         
          data-benchmark="0ef2a804-e788-4959-abb8-b4d96a18b0ef,58c7906f-70a6-4e2b-bc29-257ff2ade513,51c23f28-504f-450d-9764-0e60f1e279b2,c13897c7-de77-4e45-b23b-eec9fd66cad1,bdf40d06-5914-4f1f-aa10-77c5676fe671,31205553-b453-4c9e-a2ef-7b6aa7bfdc72"
          data-benchmark-limit="250">
        </div>
      </div>
    </sp-theme>
    <script>
      const promises = Array.from(document.querySelectorAll('[data-benchmark]')).map((c) => fillContainer(c));
      Promise.allSettled(promises).then((containers) => {
        console.log('All containers have been processed');
        const event = new Event('benchmark-done');
        document.querySelector('body').dispatchEvent(event);
      });
    </script>
  </main>
</body>
</html>
