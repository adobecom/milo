function d(l,t={},e){let s=document.createElement(l);e instanceof HTMLElement?s.appendChild(e):s.innerHTML=e;for(let[a,o]of Object.entries(t))s.setAttribute(a,o);return s}function T(l=1e3){return new Promise(t=>setTimeout(t,l))}var m="Network error",f=class{#t;constructor(t){this.#t=/^author-/.test(t);let e=`https://${t}.adobeaemcloud.com`,s=`${e}/adobe/sites`;this.cfFragmentsUrl=`${s}/cf/fragments`,this.cfSearchUrl=`${this.cfFragmentsUrl}/search`,this.cfPublishUrl=`${this.cfFragmentsUrl}/publish`,this.wcmcommandUrl=`${e}/bin/wcmcommand`,this.csrfTokenUrl=`${e}/libs/granite/csrf/token.json`,this.headers={Authorization:`Bearer ${sessionStorage.getItem("masAccessToken")??window.adobeid?.authorize?.()}`,pragma:"no-cache","cache-control":"no-cache"}}async getCsrfToken(){let t=await fetch(this.csrfTokenUrl,{headers:this.headers}).catch(s=>{throw new Error(`${m}: ${s.message}`)});if(!t.ok)throw new Error(`Failed to get CSRF token: ${t.status} ${t.statusText}`);let{token:e}=await t.json();return e}async searchFragment({path:t,query:e,variant:s}){let a={};t&&(a.path=t),e&&(a.fullText={text:encodeURIComponent(e),queryMode:"EXACT_WORDS"});let o=new URLSearchParams({query:JSON.stringify({filter:a})}).toString(),r=await fetch(`${this.cfSearchUrl}?${o}`,{headers:this.headers}).catch(c=>{throw new Error(`${m}: ${c.message}`)});if(!r.ok)throw new Error(`Search failed: ${r.status} ${r.statusText}`);let i=(await r.json()).items;return s&&(i=i.filter(c=>{let[h]=c.fields.find(g=>g.name==="variant")?.values;return h===s})),i}async getFragmentByPath(t){let e=this.#t?this.headers:{},s=await fetch(`${this.cfFragmentsUrl}?path=${t}`,{headers:e}).catch(o=>{throw new Error(`${m}: ${o.message}`)});if(!s.ok)throw new Error(`Failed to get fragment: ${s.status} ${s.statusText}`);let{items:a}=await s.json();if(!a||a.length===0)throw new Error("Fragment not found");return a[0]}async getFragment(t){let e=t.headers.get("Etag"),s=await t.json();return s.etag=e,s}async getFragmentById(t){let e=await fetch(`${this.cfFragmentsUrl}/${t}`,{headers:this.headers});if(!e.ok)throw new Error(`Failed to get fragment: ${e.status} ${e.statusText}`);return await this.getFragment(e)}async saveFragment(t){let{title:e,fields:s}=t,a=await fetch(`${this.cfFragmentsUrl}/${t.id}`,{method:"PUT",headers:{"Content-Type":"application/json","If-Match":t.etag,...this.headers},body:JSON.stringify({title:e,fields:s})}).catch(o=>{throw new Error(`${m}: ${o.message}`)});if(!a.ok)throw new Error(`Failed to save fragment: ${a.status} ${a.statusText}`);return await this.getFragment(a)}async copyFragmentClassic(t){let e=await this.getCsrfToken(),s=t.path.split("/").slice(0,-1).join("/"),a=new FormData;a.append("cmd","copyPage"),a.append("srcPath",t.path),a.append("destParentPath",s),a.append("shallow","false"),a.append("_charset_","UTF-8");let o=await fetch(this.wcmcommandUrl,{method:"POST",headers:{...this.headers,"csrf-token":e},body:a}).catch(y=>{throw new Error(`${m}: ${y.message}`)});if(!o.ok)throw new Error(`Failed to copy fragment: ${o.status} ${o.statusText}`);let r=await o.text(),h=new DOMParser().parseFromString(r,"text/html").getElementById("Message")?.textContent.trim();if(!h)throw new Error("Failed to extract new path from copy response");await T();let g=await this.getFragmentByPath(h);return g&&(g=await this.getFragmentById(g.id)),g}async publishFragment(t){let e=await fetch(this.cfPublishUrl,{method:"POST",headers:{"Content-Type":"application/json","If-Match":t.etag,...this.headers},body:JSON.stringify({paths:[t.path],filterReferencesByStatus:["DRAFT","UNPUBLISHED"],workflowModelId:"/var/workflow/models/scheduled_activation_with_references"})}).catch(s=>{throw new Error(`${m}: ${s.message}`)});if(!e.ok)throw new Error(`Failed to publish fragment: ${e.status} ${e.statusText}`);return await e.json()}async deleteFragment(t){let e=await fetch(`${this.cfFragmentsUrl}/${t.id}`,{method:"DELETE",headers:{"Content-Type":"application/json","If-Match":t.etag,...this.headers}}).catch(s=>{throw new Error(`${m}: ${s.message}`)});if(!e.ok)throw new Error(`Failed to delete fragment: ${e.status} ${e.statusText}`);return e}sites={cf:{fragments:{search:this.searchFragment.bind(this),getByPath:this.getFragmentByPath.bind(this),getById:this.getFragmentById.bind(this),save:this.saveFragment.bind(this),copy:this.copyFragmentClassic.bind(this),publish:this.publishFragment.bind(this),delete:this.deleteFragment.bind(this)}}}};var x="aem-bucket",p={CATALOG:"catalog",AH:"ah",CCD_ACTION:"ccd-action",SPECIAL_OFFERS:"special-offers"},F={[p.CATALOG]:{title:{tag:"h3",slot:"heading-xs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}},[p.AH]:{title:{tag:"h3",slot:"heading-xxs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xxs"},ctas:{size:"s"}},[p.CCD_ACTION]:{title:{tag:"h3",slot:"heading-xs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}},[p.SPECIAL_OFFERS]:{name:{tag:"h4",slot:"detail-m"},title:{tag:"h4",slot:"detail-m"},backgroundImage:{tag:"div",slot:"bg-image"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}}};async function k(l,t,e,s){let a=l.fields.reduce((n,{name:i,multiple:c,values:h})=>(n[i]=c?h:h[0],n),{id:l.id});a.model=a.model;let{variant:o="catalog"}=a;e.setAttribute("variant",o);let r=F[o]??"catalog";if(a.icon?.forEach(n=>{let i=d("merch-icon",{slot:"icons",src:n,alt:"",href:"",size:"l"});t(i)}),a.title&&r.title&&t(d(r.title.tag,{slot:r.title.slot},a.title)),a.backgroundImage&&r.backgroundImage&&t(d(r.backgroundImage.tag,{slot:r.backgroundImage.slot},`<img loading="lazy" src="${a.backgroundImage}" width="600" height="362">`)),a.prices&&r.prices){let n=a.prices,i=d(r.prices.tag,{slot:r.prices.slot},n);t(i)}if(a.description&&r.description){let n=d(r.description.tag,{slot:r.description.slot},a.description);t(n)}if(a.ctas){let n=d("div",{slot:"footer"},a.ctas),i=[];[...n.querySelectorAll("a")].forEach(c=>{let h=c.parentElement.tagName==="STRONG";if(s)c.classList.add("con-button"),h&&c.classList.add("blue"),i.push(c);else{let $=d("sp-button",{treatment:h?"fill":"outline",variant:h?"accent":"primary"},c);$.addEventListener("click",E=>{E.stopPropagation(),c.click()}),i.push($)}}),n.innerHTML="",n.append(...i),t(n)}}var w=class{#t=new Map;clear(){this.#t.clear()}add(...t){t.forEach(e=>{let{path:s}=e;s&&this.#t.set(s,e)})}has(t){return this.#t.has(t)}get(t){return this.#t.get(t)}remove(t){this.#t.delete(t)}},u=new w,b=class extends HTMLElement{#t;cache=u;refs=[];path;consonant=!1;#e;static get observedAttributes(){return["source","path","consonant"]}attributeChangedCallback(t,e,s){this[t]=s}connectedCallback(){this.consonant=this.hasAttribute("consonant"),this.clearRefs();let t=this.getAttribute(x)??"publish-p22655-e59341";this.#t=new f(t),this.refresh(!1)}clearRefs(){this.refs.forEach(t=>{t.remove()})}async refresh(t=!0){this.path&&(this.#e&&!await Promise.race([this.#e,Promise.resolve(!1)])||(this.clearRefs(),this.refs=[],t&&this.cache.remove(this.path),this.#e=this.fetchData().then(()=>!0)))}async fetchData(){let t=u.get(this.path);if(t||(t=await this.#t.sites.cf.fragments.getByPath(this.path),u.add(t)),t){k(t,s=>{this.parentElement.appendChild(s),this.refs.push(s)},this.parentElement,this.consonant);return}}get updateComplete(){return this.#e??Promise.reject(new Error("datasource is not correctly configured"))}};customElements.define("merch-datasource",b);export{b as MerchDataSource};
