/*
 * Copyright 2022 Adobe. All rights reserved.
 * This file is licensed to you under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License. You may obtain a copy
 * of the License at http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under
 * the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS
 * OF ANY KIND, either express or implied. See the License for the specific language
 * governing permissions and limitations under the License.
 */
/*
 * Japanese balanced word wrap logic
 */
let canvas=document.createElement("canvas"),context=canvas.getContext("2d"),SEP="\n",ALTERNATIVE_SEPS=/[\uff3f]/gm;function getTextWidth(e,t){context.font=t;let n=context.measureText(e);return n.width}function getCssStyle(e,t){return window.getComputedStyle(e).getPropertyValue(t)}function getCanvasFontSize(e=document.body){let t=getCssStyle(e,"font-weight")||"normal",n=getCssStyle(e,"font-size")||"16px",l=getCssStyle(e,"font-family")||"Times New Roman";return`${t} ${n} ${l}`}function separateTextAndDelimiter(e=""){let t=e.replace(ALTERNATIVE_SEPS,"\n"),n=t.split("<wbr>").join("\n"),l=[],r=[];for(let o=0;o<n.length;o+=1)"\n"===n[o]?r.length>0&&(r.pop(),r.push(1)):(r.push(0),l.push(n[o]));return{text:l.join(""),seps:r}}function getNearestWrappingPoint(e=[],t=[],n=0,l=!0){let r=-1;for(let[o,i]of t.entries())if(1===e[o]){if(i>n){if(r<0)return o;{let s=n-t[r],a=i-n;return s<=a&&l?r:o}}r=o}return r}function getChunkWidths(e=document.body,t="",n=[]){let l=Array(t.length);l.fill(0);let r=getCanvasFontSize(e);for(let[o,i]of n.entries())1===i&&(l[o]=getTextWidth(t.substring(0,o+1),r));return l[l.length-1]=getTextWidth(t,r),{widthsFromStart:l}}function insertAllLevelLineBreak(e="",t=[],n=[],l=5,r=1){let o="",i=Array(e.length),s=n[n.length-1];for(let a=1;a<=l;a+=1){let f=s/(a+1),h=f*r,g=r<=1,u=getNearestWrappingPoint(t,n,h,g);u>=0&&u<e.length&&(i[u]=i[u]||[],0>i[u].indexOf(a)&&i[u].push(a));for(let c=Math.max(n[u],f)+f;c<s;c+=f){let p=getNearestWrappingPoint(t,n,c);p>=0&&p<e.length&&(i[p]=i[p]||[],0>i[p].indexOf(a)&&i[p].push(a))}}for(let d=0;d<e.length;d+=1)if(o+=e[d],1===t[d]){if(i[d]){let $=i[d].map(e=>`jpn-balanced-wbr-l${e}`),_=$.join(" ");i[d].length>0&&(o+=`<wbr class="${_}">`)}else o+="<wbr>"}return{newText:o,poses:i}}function toggleWBR(e=document.body,t=[],n=[],l=5){let r=Array(l+1),o=n[n.length-1];r[0]=o;for(let i=1;i<=l;i+=1){let s=[];t.forEach((e,t)=>{e&&e.indexOf(i)>=0&&s.push(t)}),s.sort();let a=[],f=0;for(let h of s)a.push(n[h]-f),f=n[h];a.push(o-f),r[i]=Math.max(...a)}let g=new ResizeObserver(t=>{let n=t[0].contentRect.width;if(n>=r[0])return;let l=0;for(;l<r.length&&r[l]>n;)l+=1;l<r.length?(e.querySelectorAll(`wbr.jpn-balanced-wbr-l${l}`).forEach(e=>e.classList.remove("wbr-off")),e.querySelectorAll(`wbr:not(.jpn-balanced-wbr-l${l})`).forEach(e=>e.classList.add("wbr-off"))):e.querySelectorAll("wbr").forEach(e=>e.classList.remove("wbr-off"))});g.observe(e)}export default class e{constructor(e=5,t=1){this.maxLevel=e,this.ratio=t}applyElement=(e=document.body,t=this.ratio)=>{let n=e.childNodes,l="",r=!1;if(n.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&"WBR"!==e.nodeName?(r=!0,this.applyElement(e,t)):e.nodeType===Node.TEXT_NODE?l+=e.textContent:"WBR"===e.nodeName&&(l+="<wbr>")}),r)return;let{text:o,seps:i}=separateTextAndDelimiter(l),{widthsFromStart:s}=getChunkWidths(e,o,i),{newText:a,poses:f}=insertAllLevelLineBreak(o,i,s,this.maxLevel,t);e.innerHTML=a,toggleWBR(e,f,s,this.maxLevel)}};