<html>
  <head>
    <!-- the import map to use in our test -->
    <script type="importmap">
      {
        "imports": {
          "../../../libs/utils/utils.js": "./mocks/utils.js"
        }
      }
    </script>
  </head>

  <body>
    <main>
      <div>
        <p>Caas Demo</p>
        <p>
          <a
            id="caaslink"
            href="https://milo.adobe.com/tools/caas#eyJhZGRpdGlvbmFsUmVxdWVzdFBhcmFtcyI6W10sImFuYWx5dGljc0NvbGxlY3Rpb25OYW1lIjoiIiwiYW5hbHl0aWNzVHJhY2tJbXByZXNzaW9uIjpmYWxzZSwiYW5kTG9naWNUYWdzIjpbXSwiYm9va21hcmtJY29uU2VsZWN0IjoiIiwiYm9va21hcmtJY29uVW5zZWxlY3QiOiIiLCJjYXJkU3R5bGUiOiJoYWxmLWhlaWdodCIsImNhcmRUaXRsZUFjY2Vzc2liaWxpdHlMZXZlbCI6NiwiY29sbGVjdGlvbkJ0blN0eWxlIjoicHJpbWFyeSIsImNvbGxlY3Rpb25OYW1lIjoiIiwiY29sbGVjdGlvblNpemUiOiIiLCJjb250YWluZXIiOiIxMjAwTWF4V2lkdGgiLCJjb250ZW50VHlwZVRhZ3MiOltdLCJjb3VudHJ5IjoiY2Fhczpjb3VudHJ5L3VzIiwiY3VzdG9tQ2FyZCI6WyJjYXJkIiwiIl0sImN0YUFjdGlvbiI6Il9ibGFuayIsImRvTm90TGF6eUxvYWQiOmZhbHNlLCJkaXNhYmxlQmFubmVycyI6ZmFsc2UsImRyYWZ0RGIiOmZhbHNlLCJlbmRwb2ludCI6Ind3dy5hZG9iZS5jb20vY2hpbWVyYS1hcGkvY29sbGVjdGlvbiIsImVudmlyb25tZW50IjoiIiwiZXhjbHVkZWRDYXJkcyI6W10sImV4Y2x1ZGVUYWdzIjpbXSwiZmFsbGJhY2tFbmRwb2ludCI6IiIsImZlYXR1cmVkQ2FyZHMiOltdLCJmaWx0ZXJFdmVudCI6IiIsImZpbHRlckxvY2F0aW9uIjoibGVmdCIsImZpbHRlckxvZ2ljIjoib3IiLCJmaWx0ZXJzIjpbXSwiZmlsdGVyc1Nob3dFbXB0eSI6ZmFsc2UsImd1dHRlciI6IjR4IiwiaW5jbHVkZVRhZ3MiOltdLCJsYW5ndWFnZSI6ImNhYXM6bGFuZ3VhZ2UvZW4iLCJsYXlvdXRUeXBlIjoiNHVwIiwibG9hZE1vcmVCdG5TdHlsZSI6InByaW1hcnkiLCJvbmx5U2hvd0Jvb2ttYXJrZWRDYXJkcyI6ZmFsc2UsIm9yTG9naWNUYWdzIjpbXSwicGFnaW5hdGlvbkFuaW1hdGlvblN0eWxlIjoicGFnZWQiLCJwYWdpbmF0aW9uRW5hYmxlZCI6ZmFsc2UsInBhZ2luYXRpb25RdWFudGl0eVNob3duIjpmYWxzZSwicGFnaW5hdGlvblR5cGUiOiJub25lIiwicGFnaW5hdGlvblVzZVRoZW1lMyI6ZmFsc2UsInBsYWNlaG9sZGVyVXJsIjoiIiwicmVzdWx0c1BlclBhZ2UiOjUsInNlYXJjaEZpZWxkcyI6W10sInNldENhcmRCb3JkZXJzIjpmYWxzZSwic2hvd0Jvb2ttYXJrc0ZpbHRlciI6ZmFsc2UsInNob3dCb29rbWFya3NPbkNhcmRzIjpmYWxzZSwic2hvd0ZpbHRlcnMiOmZhbHNlLCJzaG93U2VhcmNoIjpmYWxzZSwic2hvd1RvdGFsUmVzdWx0cyI6ZmFsc2UsInNvcnREYXRlQXNjIjpmYWxzZSwic29ydERhdGVEZXNjIjpmYWxzZSwic29ydERlZmF1bHQiOiJkYXRlRGVzYyIsInNvcnRFbmFibGVQb3B1cCI6ZmFsc2UsInNvcnRFbmFibGVSYW5kb21TYW1wbGluZyI6ZmFsc2UsInNvcnRFdmVudFNvcnQiOmZhbHNlLCJzb3J0RmVhdHVyZWQiOmZhbHNlLCJzb3J0UmFuZG9tIjpmYWxzZSwic29ydFJlc2Vydm9pclBvb2wiOjEwMDAsInNvcnRSZXNlcnZvaXJTYW1wbGUiOjMsInNvcnRUaXRsZUFzYyI6ZmFsc2UsInNvcnRUaXRsZURlc2MiOmZhbHNlLCJzb3VyY2UiOlsiaGF3a3MiXSwidGFnc1VybCI6Ind3dy5hZG9iZS5jb20vY2hpbWVyYS1hcGkvdGFncyIsInRhcmdldEFjdGl2aXR5IjoiIiwidGFyZ2V0RW5hYmxlZCI6ZmFsc2UsInRoZW1lIjoibGlnaHRlc3QiLCJ0aXRsZUhlYWRpbmdMZXZlbCI6ImgzIiwidG90YWxDYXJkc1RvU2hvdyI6MTAsInVzZUxpZ2h0VGV4dCI6ZmFsc2UsInVzZU92ZXJsYXlMaW5rcyI6ZmFsc2UsInVzZXJJbmZvIjpbXX0="
            >My CaaS Collection</a
          >
        </p>
        <p>
          <a
            id="v2-caaslink"
            href="https://milo.adobe.com/tools/caas#~~H4sIAAAAAAAAE3VVTXPbNhD9Lzw7sVK3PehmyfbEM3KsRvL0kOl0VsBSxAjEsgAomen0v3cX/JSi3Ii32K+3D8t/M9DaREMO7Ff8p8YQ1+ChDNn82183GTDcRKPCkqxFJfe+QInZPMsmxq0HdXguK48h8I1snoMNKBf0ivZGbWHfx6sjLal20TcrcPvh5o7oUII/PCtyG5RMbYop/ubCxKLA601srNRSgM0/FGj2RewsWxMt3islBe2MNbFZ4RFtNv+d7UMri+j6EJU3nKfJpuax0xFLgS/Bjfk+YC6Ccej5+OmX2ewF3v80OhadCV3cNhWOfKiWC76tAMK8O97WQRzqEKlccjdd7Aj3KR0f/2YqcsY0faG4gu/NikAPbGoTYGdxAY4rCSPsIY8Pu+GMTldknBB6Op0+gqYdflRU3qrClOjhA1TmduwyE4+j8eRKdN0U8F3ZWqOWKruWOmjskbPZHQvkcUzHnjlCrP2ZZ25sRP94HKK3wKI2Vq/ByfiSgEpg0Q3mFSnoWLGYxwnOymOQ/ACd5QnLxO8ZtCno9FhWsRk42tcxpmn++s5hCgQ9hCmMxmWEZ31+Hhs37oIJy5KvYY/9uPvzLQq5Fhqqkz4kXV0JxFN9IY9XhUrONlLwonsjA5dd6eQvHl8Fe+MSV/fOlOljiMpV6Gx65dGJhEZNjZY/anCRX5TkdlfsXQcdkOgfjW8BtwWWeDc6WlBYkGVi37xtB8+LpLYxrNGvE12/3WQBwaviyaDt+Q4YpeEFeT1VeZhQEp7SXK/bXt05X2J86nUywTYp8xm0pSjrMhU5GsjHB4h4H9QP2ANeAV9Im9xMOE4GzIHDMg+692sN7UDWVLEypg4t/pV3LZUbKCtrJns1XZAHteGPM/Spe39nYF/RZQs9/kMbbdpzCAP6Ixm/JuJxfprNZheGVCVP9a7F2119ETiBF+lqr9jrG6/70yFkrIDI0m418/P9JXcyuer3GGV/Ho0872zALoUeRZ6yTOR3wr9D2bLIS92GLb7H16rbNbqbEztIqZ95MzDx3V8mK+7EICpJGtuSPBYh4yarA64ktEQbkjL4ekTPK2Bl3GHU1ORfxYuIrmwB9vTPLid5E//9DxyYdnXOBwAA"
            >My CaaS Collection</a
          >
        </p>
      </div>
    </main>
  </body>
  <script type="module">
    import { runTests } from '@web/test-runner-mocha';
    import { expect } from '@esm-bundle/chai';
    import { stub } from 'sinon';
    import init from '../../../libs/blocks/caas/caas.js';
    import { loadScript, loadStyle } from '../../../libs/utils/utils.js';
    import { delay, waitForElement } from '../../helpers/waitfor.js';

    let config;
    let caasEl;

    class ConsonantCardCollection {
      constructor(cfg, el) {
        config = cfg;
        caasEl = el;
      }
    }

    window.ConsonantCardCollection = ConsonantCardCollection;

    runTests(() => {
      describe('CaaS', () => {
        const ogFetch = window.fetch;

        beforeEach(() => {
          document.getElementById('caas')?.remove();
          caasEl = null;
          loadScript.reset();
          loadStyle.reset();

          window.fetch = stub().returns(
            new Promise((resolve) => {
              resolve({
                ok: true,
                json: () => ({
                  data: [
                    {
                      key: 'collectionTitle',
                      val: 'My Awesome Title',
                    },
                    {
                      key: 'onErrorTitle',
                      val: 'Error Loading Title',
                    },
                    {
                      key: 'onErrorDesc',
                      val: 'Error Desc',
                    },
                  ],
                }),
              });
            })
          );
        });

        afterEach(() => {
          window.fetch = ogFetch;
        });

        it('inits the CaaS collection', async () => {
          const a = document.getElementById('caaslink');
          await init(a);
          await waitForElement('#caas');
          await delay(50);
          expect(loadScript.callCount).to.equal(3);
          expect(loadStyle.callCount).to.equal(1);
          expect(caasEl).to.equal(document.getElementById('caas'));
        });

        it('it can use the v2 hash format', async () => {
          const a = document.getElementById('v2-caaslink');
          await init(a);
          await waitForElement('#caas');
          await delay(50);
          expect(loadScript.callCount).to.equal(3);
          expect(loadStyle.callCount).to.equal(1);
          expect(caasEl).to.equal(document.getElementById('caas'));
        });
      });
    });
  </script>
</html>
