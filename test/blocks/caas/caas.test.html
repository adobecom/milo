<html>
  <head>
    <!-- the import map to use in our test -->
    <script type="importmap">
      {
        "imports": {
          "../../../libs/utils/utils.js": "./mocks/utils.js"
        }
      }
    </script>
  </head>

  <body>
    <main>
      <div>
        <p>Caas Demo</p>
        <p>
          <a
            id="caaslink"
            href="https://milo.adobe.com/tools/caas#eyJhbmFseXRpY3NUcmFja0ltcHJlc3Npb24iOmZhbHNlLCJhbmFseXRpY3NDb2xsZWN0aW9uTmFtZSI6IiIsImFuZExvZ2ljVGFncyI6W10sImJvb2ttYXJrSWNvblNlbGVjdCI6IiIsImJvb2ttYXJrSWNvblVuc2VsZWN0IjoiIiwiY2FyZFN0eWxlIjoiaGFsZi1oZWlnaHQiLCJjb2xsZWN0aW9uQnRuU3R5bGUiOiJwcmltYXJ5IiwiY29udGFpbmVyIjoiMTIwME1heFdpZHRoIiwiY291bnRyeSI6ImNhYXM6Y291bnRyeS91cyIsImNvbnRlbnRUeXBlVGFncyI6W10sImRpc2FibGVCYW5uZXJzIjpmYWxzZSwiZHJhZnREYiI6ZmFsc2UsImVudmlyb25tZW50IjoiIiwiZW5kcG9pbnQiOiJ3d3cuYWRvYmUuY29tL2NoaW1lcmEtYXBpL2NvbGxlY3Rpb24iLCJleGNsdWRlVGFncyI6W10sImV4Y2x1ZGVkQ2FyZHMiOltdLCJmYWxsYmFja0VuZHBvaW50IjoiIiwiZmVhdHVyZWRDYXJkcyI6W10sImd1dHRlciI6IjR4IiwiaW5jbHVkZVRhZ3MiOltdLCJsYW5ndWFnZSI6ImNhYXM6bGFuZ3VhZ2UvZW4iLCJsYXlvdXRUeXBlIjoiNHVwIiwibG9hZE1vcmVCdG5TdHlsZSI6InByaW1hcnkiLCJvbmx5U2hvd0Jvb2ttYXJrZWRDYXJkcyI6ZmFsc2UsIm9yTG9naWNUYWdzIjpbXSwicGFnaW5hdGlvbkFuaW1hdGlvblN0eWxlIjoicGFnZWQiLCJwYWdpbmF0aW9uRW5hYmxlZCI6ZmFsc2UsInBhZ2luYXRpb25RdWFudGl0eVNob3duIjpmYWxzZSwicGFnaW5hdGlvblVzZVRoZW1lMyI6ZmFsc2UsInBhZ2luYXRpb25UeXBlIjoibm9uZSIsInBsYWNlaG9sZGVyVXJsIjoiL215L3BsYWNlaG9sZGVycy5qc29uIiwicmVzdWx0c1BlclBhZ2UiOjUsInNlYXJjaEZpZWxkcyI6W10sInNldENhcmRCb3JkZXJzIjpmYWxzZSwic2hvd0Jvb2ttYXJrc0ZpbHRlciI6ZmFsc2UsInNob3dCb29rbWFya3NPbkNhcmRzIjpmYWxzZSwic2hvd0ZpbHRlcnMiOmZhbHNlLCJzaG93U2VhcmNoIjpmYWxzZSwic2hvd1RvdGFsUmVzdWx0cyI6ZmFsc2UsInNvcnREZWZhdWx0IjoiZGF0ZURlc2MiLCJzb3J0RW5hYmxlUG9wdXAiOmZhbHNlLCJzb3J0RW5hYmxlUmFuZG9tU2FtcGxpbmciOmZhbHNlLCJzb3J0UmVzZXJ2b2lyU2FtcGxlIjozLCJzb3J0UmVzZXJ2b2lyUG9vbCI6MTAwMCwic291cmNlIjpbImhhd2tzIl0sInRhZ3NVcmwiOiJ3d3cuYWRvYmUuY29tL2NoaW1lcmEtYXBpL3RhZ3MiLCJ0YXJnZXRBY3Rpdml0eSI6IiIsInRhcmdldEVuYWJsZWQiOmZhbHNlLCJ0aGVtZSI6ImxpZ2h0ZXN0IiwidG90YWxDYXJkc1RvU2hvdyI6MTAsInVzZUxpZ2h0VGV4dCI6ZmFsc2UsInVzZU92ZXJsYXlMaW5rcyI6ZmFsc2UsInVzZXJJbmZvIjpbXX0="
            >My CaaS Collection</a
          >
        </p>
      </div>
    </main>
  </body>
  <script type="module">
    import { runTests } from '@web/test-runner-mocha';
    import { expect } from '@esm-bundle/chai';
    import { stub } from 'sinon';
    import init from '../../../libs/blocks/caas/caas.js';
    import { loadScript, loadStyle } from '../../../libs/utils/utils.js';
    import { delay, waitForElement } from '../../helpers/waitfor.js';

    let config;
    let caasEl;

    class ConsonantCardCollection {
      constructor(cfg, el) {
        config = cfg;
        caasEl = el;
      }
    }

    window.ConsonantCardCollection = ConsonantCardCollection;

    runTests(() => {
      describe('loadStrings', () => {
        const ogFetch = window.fetch;

        beforeEach(() => {
          window.fetch = stub().returns(
            new Promise((resolve) => {
              resolve({
                ok: true,
                json: () => ({
                  data: [
                    {
                      key: 'collectionTitle',
                      val: 'My Awesome Title',
                    },
                    {
                      key: 'onErrorTitle',
                      val: 'Error Loading Title',
                    },
                    {
                      key: 'onErrorDesc',
                      val: 'Error Desc',
                    },
                  ],
                }),
              });
            })
          );
        });

        afterEach(() => {
          window.fetch = ogFetch;
        });

        it('inits the CaaS collection', async () => {
          const a = document.getElementById('caaslink');
          await init(a);
          await waitForElement('#caas');
          await delay(5);
          expect(loadScript.callCount).to.equal(3);
          expect(loadStyle.callCount).to.equal(1);
          expect(caasEl).to.equal(document.getElementById('caas'));
        });
      });
    });
  </script>
</html>
