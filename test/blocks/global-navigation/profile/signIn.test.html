<html>
  <head>
    <script type="importmap">
        {
          "imports": {
            "../../../../libs/features/placeholders.js": "./mocks/replaceKey.js"
          }
        }
      </script>
  </head>
  <body>
    <script type="module">
      import { expect } from '@esm-bundle/chai';
      import { runTests } from '@web/test-runner-mocha';
      import { toFragment } from '../../../../libs/blocks/global-navigation/utilities/utilities.js';
      import decorateSignIn from '../../../../libs/blocks/global-navigation/blocks/profile/signIn.js';
      import {replaceKey} from '../../../../libs/features/placeholders.js'
      import { setConfig } from '../../../../libs/utils/utils.js';
      const config = {
        codeRoot: '/libs',
        locales: { '': { ietf: 'en-US', tk: 'hah7vzn.css' } },
      };
      setConfig(config);

      const signInDropdown = () => toFragment`
            <div>
              <div>
                <ul>
                  <li><a href="https://business.adobe.com/products/workfront/login.html">Workfront</a></li>
                  <li><a href="https://adobe.com?sign-in=true">Adobe Account</a></li>
                </ul>
              </div>
            </div>
          `;

      const blockEl = (dropdown) => toFragment`
          <div class="profile">
            <div>
              <div>
                <h5 id="acrobat">Acrobat</h5>
                <ul>
                  <li><a href="https://adobe.com/settings">Settings</a></li>
                  <li><a href="https://adobe.com/my-plan">My plan</a></li>
                  <li><a href="https://adobe.com/third-link">Some third link</a></li>
                </ul>
              </div>
            </div>
            ${dropdown}
          </div>
          `;

      runTests(() => {
        describe('Profile Sign In button:', () => {
          afterEach(() => {
            window.adobeIMS = undefined;
          });

          it('Creates a sign in button', async () => {
            const decoratedEl = toFragment`<div class="feds-profile"></div>`;
            const signIn = await decorateSignIn({
              blockEl: blockEl(''),
              decoratedEl,
            });
            expect(signIn.nodeName).to.equal('A');
            expect(signIn.getAttribute('href')).to.equal('#');
            expect(signIn.getAttribute('daa-ll')).to.equal('Sign in Mockholder');
            expect(signIn.getAttribute('role')).to.equal(null);
            expect(signIn.classList.contains('feds-signin')).to.equal(true);
            expect(signIn.innerText).to.equal('Sign in Mockholder');
          });

          it('Links IMS to the sign in button', (done) => {
            const decoratedEl = toFragment`<div class="feds-profile"></div>`;
            decorateSignIn({
              blockEl: blockEl(''),
              decoratedEl,
            }).then((signInEl) => {
              window.adobeIMS = { signIn: () => done() };
              signInEl.click();
            });
          });

          it('Creates a sign in dropdown', async () => {
            const decoratedEl = toFragment`<div class="feds-profile"></div>`;
            const signIn = await decorateSignIn({
              blockEl: blockEl(signInDropdown()),
              decoratedEl,
            });
            expect(signIn.nodeName).to.equal('A');
            expect(signIn.getAttribute('href')).to.equal('#');
            expect(signIn.getAttribute('daa-ll')).to.equal('Sign in Mockholder');
            expect(signIn.getAttribute('role')).to.equal('button');
            expect(signIn.getAttribute('aria-expanded')).to.equal('false');
            expect(signIn.getAttribute('aria-controls')).to.equal('navmenu-profile');
            expect(signIn.getAttribute('daa-lh')).to.equal('header|Close');
            expect(signIn.getAttribute('aria-haspopup')).to.equal('true');
            expect(signIn.classList.contains('feds-signin')).to.equal(true);
            expect(signIn.innerText).to.equal('Sign in Mockholder');
          });

          it('Disables sign in when there is a dropdown', (done) => {
            const decoratedEl = toFragment`<div class="feds-profile"></div>`;
            decorateSignIn({
              blockEl: blockEl(signInDropdown()),
              decoratedEl,
            }).then((signInEl) => {
              window.adobeIMS = {
                signIn: () => {
                  throw new Error('This should not happen!');
                },
              };
              signInEl.click();
              done();
            });
          });

          it('Sign in a user, using the dropdown', (done) => {
            const decoratedEl = toFragment`<div class="feds-profile"></div>`;
            decorateSignIn({
              blockEl: blockEl(signInDropdown()),
              decoratedEl,
            }).then(() => {
              window.adobeIMS = { signIn: () => done() };
              decoratedEl.querySelector('[href="https://adobe.com?sign-in=true"]').click();
            });
          });

          it('Sign in dropdown button emits an event on click', (done) => {
            const decoratedEl = toFragment`<div class="feds-profile"></div>`;
            decorateSignIn({
              blockEl: blockEl(signInDropdown()),
              decoratedEl,
            }).then((signIn) => {
              window.addEventListener('feds:profileSignIn:clicked', () => done(), { once: true });
              signIn.click();
            });
          });
        });

      });
    </script>
  </body>
</html>
