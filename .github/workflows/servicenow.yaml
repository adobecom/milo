name: Create CMR in ServiceNow

on:
  pull_request:
    types:
      - closed
    branches:
      - servicenow-cmr-test

jobs:
  create-cmr:
    # Only run this workflow on pull requests that have merged and not manually closed by user
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Runs a single command using the runners shell for shell validation
      - name: Validate Shell
        run: echo Starting CMR Action...

      - name: Check Dependencies
        run: |
          if ! type "jq" >/dev/null; then
            echo "jq is required but not installed"
            exit 1
          fi

          if ! type "curl" >/dev/null; then
            echo "curl is required but not installed"
            exit 1
          fi

          echo "Dependencies check was successful"

      - name: Set Planned Maintenance Time Windows for CMR
        run: |
          echo "start_time=$(date -d "+60 minutes" '+%Y-%m-%d %H:%M')" >> $GITHUB_ENV
          echo "end_time=$(date -d "+90 minutes" '+%Y-%m-%d %H:%M')" >> $GITHUB_ENV

      - name: Set Release Summary for CMR
        run: |
          function sanitizeStr() {
            local str=$1

            if [ -z "$str" ]; then
              echo "First parameter missing, must be a valid string"
              return 1
            fi

            str="${str//\"/""}"
            str="${str//\'/""}"
            str="${str//(/"["}"
            str="${str//)/"]"}"
            str="${str//$'\r'/"\r"}"
            str="${str//$'\n'/"\n"}"
            str="${str//$'\t'/"\t"}"
            str="${str//$'\b'/"\b"}"
            str="${str//\\//}"
            str="${str////"\/"}"

            echo "$str"
          }

          release_title=$(sanitizeStr "${{ github.event.pull_request.title }}") >> $GITHUB_ENV
          release_details=$(sanitizeStr "${{ github.event.pull_request.body }}")
          release=Release_Title--"${release_title}"--Release_Details--"${release_details}"--Pull_Request_Number--"${{ github.event.pull_request.number }}"--Pull_Request_Created_At--"${{ github.event.pull_request.created_at }}"--Pull_Request_Merged_At--"${{ github.event.pull_request.merged_at }}"

          echo "release_summary<<RS_EOF" >> $GITHUB_ENV
          echo "$release" >> $GITHUB_ENV
          echo "RS_EOF" >> $GITHUB_ENV

      - name: Get IMS Token
        run: |
          DEFAULT_IMS_URL='https://ims-na1-stg1.adobelogin.com/ims/token'

          function ims_request() {
            local client_id=$1
            local client_secret=$2
            local ims_code=$3
            local url=$4

            if [ -z "$client_id" ]; then
              echo "Missing IMS client ID"
              return 1
            fi

            if [ -z "$client_secret" ]; then
              echo "Missing IMS client secret"
              return 1
            fi

            if [ -z "$ims_code" ]; then
              echo "Missing IMS Code"
              return 1
            fi

            if [ -z "$url" ]; then
              url=$DEFAULT_IMS_URL
            fi

            curl --request POST --silent --url "${url}" --header 'content-type: multipart/form-data' --form client_id=${client_id} --form client_secret=${client_secret} --form grant_type=authorization_code --form code=${ims_code} > response.txt

            if [ -s response.txt ]; then
              echo "CURL call failed, returned response copied to response.txt was empty."
              exit 1
            elif grep -q "\"error\"" response.txt; then
              echo "IMS token request failed with response: "
              cat response.txt
              exit 1
            else
              echo "IMS token request was successful"
              token=$(jq -r '.access_token' response.txt) >> GITHUB_ENV
              echo "${token}"
            fi
          }

          ims_request ${{ secrets.IMSACCESS_CLIENT_ID }} ${{ secrets.IMSACCESS_CLIENT_SECRET_STAGE }} ${{ secrets.IMSACCESS_AUTH_CODE_STAGE }}

      - name: Create CMR in ServiceNow
        run: |
          DEFAULT_SERVICENOW_URL='https://ipaasapi-stage.adobe-services.com/change_management/changes'

          function servicenow_create_cmr() {
            local api_key=$1
            local access_token=$2
            local title=$3
            local description=$4
            local start_time=$5
            local end_time=$6
            local url=$7

            if [ -z "$api_key" ]; then
              echo "Missing ServiceNow API key"
              return 1
            fi

            if [ -z "$access_token" ]; then
              echo "Missing IMS access token"
              return 1
            fi

            if [ -z "$title" ]; then
              echo "Missing title"
              return 1
            fi

            if [ -z "$description" ]; then
              echo "Missing description"
              return 1
            fi

            if [ -z "$start_time" ]; then
              echo "Missing start time"
              return 1
            fi

            if [ -z "$end_time" ]; then
              echo "Missing end time"
              return 1
            fi

            if [ -z "$url" ]; then
              url=$DEFAULT_SERVICENOW_URL
            fi

            curl --request POST --silent --url "${url}" --header "api_key: ${api_key}" --header "Authorization: ${access_token}" -d '{"title": "${title}", "description": "${description}", "instanceIds": [ 537445 ], "plannedStartDate": ${start_time}, "plannedEndDate": ${end_time}, "coordinator": "narcis@adobe.com", "executor": "mauchley@adobe.com", "customerImpact": "No Impact", "changeReason": [ "New Features", "Bug Fixes", "Enhancement", "Maintenance", "Security" ], "risk": "Straight Forward", "preProductionTestingType": [ "End-to-End", "Functional", "Integrations", "QA", "Regression", "UAT", "Unit Test" ], "backoutPlanType": "Roll back", "approvedBy": [ "osahin@adobe.com" ], "testPlan": "Test plan is documented in the PR link in the Milo repository above. See the PR's merge checks to see Unit and Nala testing.", "implementationPlan": "The change will be realeased as part of the continuous deployment of Milo's production branch, i.e., \"main\"", "backoutPlan": "Revert merge to the Milo production branch by creating a revert commit.", "testResults": "Changes are tested and validated successfully in staging environment. Please see the link of the PR in the description for the test results and/or the \"#nala-test-results\" slack channel."}' > response.txt

            if [ -s response.txt ]; then
              echo "CURL call failed, returned response copied to response.txt was empty."
              exit 1
            elif grep -q "\"error\"" response.txt; then
              echo "CMR creation failed with response: "
              cat response.txt
              exit 1
            else
              echo "CMR creation was successful"
              transaction_id=$(jq -r '.id' response.txt) >> GITHUB_ENV
              echo "${transaction_id}"
            fi
          }

          servicenow_create_cmr ${{ secrets.IPAAS_KEY_STAGE }} ${{ env.token }} "${{ env.release_title }}" "${{ env.release_summary }}" ${{ env.start_time }} ${{ env.end_time }}

      - name: Retrieve CMR ID in ServiceNow
        run: |
          DEFAULT_SERVICENOW_URL='https://ipaasapi-stage.adobe-services.com/change_management/transactions'

          function servicenow_request_cmr() {
            local api_key=$1
            local access_token=$2
            local transaction_id=$3
            local url=$4

            if [ -z "$api_key" ]; then
              echo "Missing ServiceNow API key"
              return 1
            fi

            if [ -z "$access_token" ]; then
              echo "Missing IMS access token"
              return 1
            fi

            if [ -z "$transaction_id" ]; then
              echo "Missing transaction ID"
              return 1
            fi

            if [ -z "$url" ]; then
              url=$DEFAULT_SERVICENOW_URL
              url+="/${transaction_id}"
            fi

            curl --request GET --silent --url "${url}" --header "api_key: ${api_key}" --header "Authorization: ${access_token}" > response.txt

            if [ -s response.txt ]; then
              echo "CURL call failed, returned response copied to response.txt was empty."
              exit 1
            elif grep -q "\"error\"" response.txt; then
              echo "CMR ID retrieval failed with response: "
              cat response.txt
              exit 1
            else
              echo "CMR ID retrieval was successful"
              cmr_id=$(jq -r '.changeId' response.txt) >> GITHUB_ENV
              echo "${cmr_id}"
            fi
          }

          servicenow_request_cmr ${{ secrets.IPAAS_KEY_STAGE }} ${{ env.token }} ${{ env.transaction_id }}

      - name: Set Actual Maintenance Time Windows for CMR
        run: |
          echo "actual_start_time=$(date -d '+%Y-%m-%d %H:%M')" >> $GITHUB_ENV
          echo "actual_end_time=$(date -d "+5 minutes" '+%Y-%m-%d %H:%M')" >> $GITHUB_ENV

      - name: Close CMR in ServiceNow
        run: |
          DEFAULT_SERVICENOW_URL='https://ipaasapi-stage.adobe-services.com/change_management/changes'

          function servicenow_close_cmr() {
            local api_key=$1
            local access_token=$2
            local actual_start_time=$3
            local actual_end_time=$4
            local cmr_id=$5
            local url=$6

            if [ -z "$api_key" ]; then
              echo "Missing ServiceNow API key"
              return 1
            fi

            if [ -z "$access_token" ]; then
              echo "Missing IMS access token"
              return 1
            fi

            if [ -z "$actual_start_time" ]; then
              echo "Missing actual start time"
              return 1
            fi

            if [ -z "$actual_end_time" ]; then
              echo "Missing actual end time"
              return 1
            fi

            if [ -z "$cmr_id" ]; then
              echo "Missing change management request ID"
              return 1
            fi

            if [ -z "$url" ]; then
              url=$DEFAULT_SERVICENOW_URL
              url+="/${cmr_id}"
            fi

            curl --request POST --silent --url "${url}" --header "api_key: ${api_key}" --header "Authorization: ${access_token}" -d '{"actualStartDate": ${actual_start_time}, "actualEndDate": ${actual_end_time}, "state": "Closed", "closeCode": "Successful", "notes": "The change request is closed as the change was released successfully"}' > response.txt

            if [ -s response.txt ]; then
              echo "CURL call failed, returned response copied to response.txt was empty."
              exit 1
            elif grep -q "\"error\"" response.txt; then
              echo "CMR closure failed with response: "
              cat response.txt
              exit 1
            else
              echo "CMR closure was successful"
            fi
          }

          servicenow_close_cmr ${{ secrets.IPAAS_KEY_STAGE }} ${{ env.token }} ${{ env.actual_start_time }} ${{ env.actual_end_time }} ${{ env.cmr_id }}
